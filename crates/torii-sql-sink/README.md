# Torii SQL Sink

A demonstration sink for Torii that processes SQL operations and stores them in SQLite or PostgreSQL.

## Features

This sink demonstrates all three Torii extension points:

1. **EventBus** - Publishes to central topic-based subscriptions (via `torii.Torii/Subscribe`)
2. **gRPC Service** - Provides `torii.sinks.sql.SqlSink` service with:
   - `Query` - Execute SQL queries
   - `StreamQuery` - Stream large result sets
   - `GetSchema` - Get database schema
   - `Subscribe` - Real-time operation updates
3. **REST HTTP** - Exposes:
   - `POST /sql/query` - Execute SQL queries
   - `GET /sql/events` - List all SQL operations

## Usage

```rust
use std::sync::Arc;
use torii::{ToriiConfig, run};
use torii_sql_sink::{SqlDecoder, SqlSink};
use tonic::transport::Server;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // 1. Create sink
    let sql_sink = SqlSink::new("postgres://torii:torii@localhost:5432/torii").await?;

    // 2. Get the gRPC service implementation
    let sql_grpc_service = sql_sink.get_grpc_service_impl();

    // 3. Build gRPC router with SQL sink service
    let grpc_router = {
        use torii_sql_sink::proto::sql_sink_server::SqlSinkServer;

        Server::builder()
            .accept_http1(true)
            .add_service(tonic_web::enable(SqlSinkServer::new((*sql_grpc_service).clone())))
    };

    // 4. Create decoder
    let sql_decoder = Arc::new(SqlDecoder::new(Vec::new())); // No filters

    // 5. Get sample events
    let sample_events = SqlSink::generate_sample_events();

    // 6. Configure and run Torii
    let config = ToriiConfig::builder()
        .port(8080)
        .add_sink_boxed(Box::new(sql_sink))
        .add_decoder(sql_decoder)
        .with_grpc_router(grpc_router)
        .with_sample_events(sample_events)
        .build();

    run(config).await
}
```

## Protobuf Code Generation

The gRPC service definitions are in `proto/sql.proto`. The Rust code is automatically generated during build.

### Generated Files

- **Location**: `src/generated/torii.sinks.sql.rs`
- **Generated by**: `build.rs` (runs automatically with `cargo build`)
- **Includes**: Service trait, message types, client/server stubs

### How to Regenerate

The protobuf code is automatically regenerated when:

1. **Building the crate**: `cargo build -p torii-sql-sink`
2. **Proto file changes**: Any modification to `proto/sql.proto` triggers regeneration

### Manual Regeneration

If you need to force regeneration:

```bash
# Clean and rebuild
cargo clean -p torii-sql-sink
cargo build -p torii-sql-sink

# Or touch the proto file to trigger rebuild
touch crates/torii-sql-sink/proto/sql.proto
cargo build -p torii-sql-sink
```

### Build Process

The `build.rs` script:

1. Creates `src/generated/` directory if it doesn't exist
2. Configures `tonic-build` to generate server code (no client)
3. Compiles `proto/sql.proto` into Rust code
4. Outputs to `src/generated/torii.sinks.sql.rs`

See `build.rs` for implementation details.

## Architecture

```
┌─────────────────────────────────────────────────┐
│              SqlSink                            │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌────────────────┐      ┌─────────────────┐  │
│  │  SqlDecoder    │─────▶│  SqlOperation   │  │
│  │                │      │  (SQLite)       │  │
│  │  Events → SQL  │      │  Database       │  │
│  └────────────────┘      └─────────────────┘  │
│                                  │              │
│                    ┌─────────────┼──────────┐  │
│                    │             │          │  │
│                    ▼             ▼          ▼  │
│           ┌──────────────┐  ┌────────┐  ┌────┐│
│           │  EventBus    │  │  gRPC  │  │HTTP││
│           │  (central)   │  │  APIs  │  │API ││
│           └──────────────┘  └────────┘  └────┘│
│                                                 │
└─────────────────────────────────────────────────┘
```

## Storage

- **Database**: Stores SQL operations (insert, update, etc.) in SQLite or PostgreSQL.
- **Schema**:
  ```sql
  CREATE TABLE sql_operation (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      table_name TEXT NOT NULL,
      operation TEXT NOT NULL,
      value INTEGER NOT NULL,
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  )
  ```
- **Thread-Safe**: Uses `Arc<Pool<Any>>` for concurrent access

## Filtering

The SqlSink supports filtering via EventBus subscriptions:

- `table` - Filter by table name (e.g., "user", "order")
- `operation` - Filter by operation type (e.g., "insert", "update")
- `value_gt` - Value greater than
- `value_lt` - Value less than
- `value_gte` - Value greater than or equal
- `value_lte` - Value less than or equal
- `value_eq` - Value equal to

Example subscription:
```json
{
  "topics": ["sql"],
  "filters": {
    "sql": {
      "table": "user",
      "operation": "insert",
      "value_gt": "100"
    }
  }
}
```

## gRPC Service Registration

Due to Rust's type system limitations, gRPC services must be registered by the user:

```rust
// User code (e.g., main.rs or examples/)
use torii_sql_sink::proto::sql_sink_server::SqlSinkServer;
use tonic::transport::Server;

let sql_sink = SqlSink::new("postgres://torii:torii@localhost:5432/torii").await?;
let service = sql_sink.get_grpc_service_impl();

let grpc_router = Server::builder()
    .accept_http1(true)
    .add_service(tonic_web::enable(SqlSinkServer::new((*service).clone())));

// Pass router to Torii
let config = ToriiConfig::builder()
    .add_sink_boxed(Box::new(sql_sink))
    .with_grpc_router(grpc_router)
    .build();
```

This pattern keeps all gRPC services on the same port while maintaining type safety.

## Testing

```bash
# Build
cargo build -p torii-sql-sink

# Run tests
cargo test -p torii-sql-sink

# Test gRPC (with server running)
grpcurl -plaintext localhost:8080 torii.sinks.sql.SqlSink/Query
grpcurl -plaintext localhost:8080 torii.sinks.sql.SqlSink/GetSchema

# Test HTTP
curl -X POST http://localhost:8080/sql/query -d '{"query":"SELECT * FROM sql_operation"}'
curl http://localhost:8080/sql/events
```

## See Also

- **Example**: `examples/simple_sql_sink` - Basic SqlSink usage
- **Example**: `examples/multi_sink_example` - Multi-sink usage (SqlSink + LogSink)
- **Log Sink**: `crates/torii-log-sink` - Similar architecture with in-memory storage
