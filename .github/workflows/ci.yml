name: CI

on:
  pull_request:
  push:
    branches: [main]

# Cancel previous runs on the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  format-and-lint:
    name: Format & Lint
    runs-on: ubuntu-latest-4-cores
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          cache-on-failure: true

      - name: Install protoc
        uses: arduino/setup-protoc@v2
        with:
          version: "25.x"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest-4-cores
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          cache-on-failure: true

      - name: Install protoc
        uses: arduino/setup-protoc@v2
        with:
          version: "25.x"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run tests
        run: cargo test --workspace

      - name: Build examples
        run: cargo build --examples

  benchmark-regression:
    name: Benchmark Regression Check
    runs-on: ubuntu-latest-8-cores
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          cache-on-failure: true

      - name: Install protoc
        uses: arduino/setup-protoc@v2
        with:
          version: "25.x"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore benchmark baseline
        id: cache-baseline
        uses: actions/cache@v4
        with:
          path: scripts/perf/baselines
          key: benchmark-baseline-${{ github.base_ref || 'main' }}-${{ github.sha }}
          restore-keys: |
            benchmark-baseline-${{ github.base_ref || 'main' }}-

      - name: Run benchmark regression check
        if: github.event_name == 'pull_request' && steps.cache-baseline.outputs.cache-hit == 'true'
        id: regression-check
        continue-on-error: true
        run: |
          set -o pipefail
          ./scripts/perf/compare_to_baseline.sh | tee benchmark-results.txt
          echo "EXIT_CODE=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Post regression results to PR
        if: github.event_name == 'pull_request' && steps.cache-baseline.outputs.cache-hit == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let resultsText = '';
            try {
              resultsText = fs.readFileSync('benchmark-results.txt', 'utf8');
            } catch (e) {
              resultsText = 'Failed to read benchmark results';
            }

            const hasRegressions = '${{ steps.regression-check.outputs.EXIT_CODE }}' !== '0';
            const status = hasRegressions ? '❌ **Benchmark Regression Detected**' : '✅ **No Benchmark Regressions**';

            const body = `## ${status}

            <details>
            <summary>Benchmark Comparison Results</summary>

            \`\`\`
            ${resultsText}
            \`\`\`

            </details>

            ${hasRegressions ? '\n⚠️ **This PR contains performance regressions >10% and cannot be merged.**\n\nPlease optimize the code or update the baseline if this regression is intentional.' : ''}
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Benchmark')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if regressions detected
        if: github.event_name == 'pull_request' && steps.regression-check.outputs.EXIT_CODE != '0'
        run: |
          echo "❌ Benchmark regressions detected (>10% threshold)"
          exit 1

      - name: Update baseline on main branch
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: ./scripts/perf/run_baseline.sh

      - name: Save new baseline
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: scripts/perf/baselines
          key: benchmark-baseline-main-${{ github.sha }}
